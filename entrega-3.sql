CREATE TABLE JUEGOS(
    ID_JUEGO NUMBER PRIMARY KEY,
    TITULO VARCHAR2(150) NOT NULL,
    FECHA_LANZAMIENTO DATE
);

CREATE TABLE PLATAFORMAS(
    ID_PLATAFORMA NUMBER PRIMARY KEY,
    NOMBRE VARCHAR2(20) NOT NULL
);

CREATE TABLE DESARROLLADORES (
    ID_DESARROLLADOR NUMBER PRIMARY KEY,
    NOMBRE_DESARROLLADOR VARCHAR2(30) NOT NULL UNIQUE
);

CREATE TABLE GENEROS(
    ID_GENERO NUMBER PRIMARY KEY,
    NOMBRE_GENERO VARCHAR2(30) NOT NULL UNIQUE
);

CREATE TABLE JUEGOS_PLATAFORMA(
    ID_JUEGO NUMBER,
    ID_PLATAFORMA NUMBER,
    CONSTRAINT FK_JP_JUEGO FOREIGN KEY (ID_JUEGO) REFERENCES JUEGOS(ID_JUEGO) ON DELETE CASCADE,
    CONSTRAINT FK_JP_PLATAFORMA FOREIGN KEY (ID_PLATAFORMA) REFERENCES PLATAFORMAS(ID_PLATAFORMA) ON DELETE CASCADE,
    PRIMARY KEY(ID_JUEGO, ID_PLATAFORMA)
);

ALTER TABLE JUEGOS
ADD ID_DESARROLLADOR NUMBER;

ALTER TABLE JUEGOS
ADD ID_GENERO NUMBER;

ALTER TABLE JUEGOS
ADD CONSTRAINT FK_JUEGO_DESARROLADOR
FOREIGN KEY(ID_DESARROLLADOR) REFERENCES DESARROLLADORES (ID_DESARROLLADOR);

ALTER TABLE JUEGOS
ADD CONSTRAINT FK_JUEGO_GENERO
FOREIGN KEY (ID_GENERO) REFERENCES GENEROS(ID_GENERO);

ALTER TABLE JUEGOS
ADD CONSTRAINT UQ_JUEGO_TITULO UNIQUE (TITULO);

INSERT INTO DESARROLLADORES(ID_DESARROLLADOR, NOMBRE_DESARROLLADOR) VALUES (1, 'TOBY FOX');
INSERT INTO DESARROLLADORES(ID_DESARROLLADOR, NOMBRE_DESARROLLADOR) VALUES (2, 'NINTENDO EPD');
INSERT INTO DESARROLLADORES(ID_DESARROLLADOR, NOMBRE_DESARROLLADOR) VALUES (3, 'INFINITY WARD');
INSERT INTO DESARROLLADORES(ID_DESARROLLADOR, NOMBRE_DESARROLLADOR) VALUES (4, 'VALVE');

INSERT INTO GENEROS(ID_GENERO, NOMBRE_GENERO) VALUES (10,'RPG');
INSERT INTO GENEROS(ID_GENERO, NOMBRE_GENERO) VALUES (20,'PLATAFORMAS');
INSERT INTO GENEROS(ID_GENERO, NOMBRE_GENERO) VALUES (30,'SHOOTER');
INSERT INTO GENEROS(ID_GENERO, NOMBRE_GENERO) VALUES (40,'MOBA');

INSERT INTO JUEGOS(ID_JUEGO, TITULO, FECHA_LANZAMIENTO, ID_DESARROLLADOR, ID_GENERO)
VALUES (101, 'DELTARUNE', TO_DATE('2018-10-31', 'YYYY-MM-DD'), 1, 10);
INSERT INTO JUEGOS(ID_JUEGO, TITULO, FECHA_LANZAMIENTO, ID_DESARROLLADOR, ID_GENERO)
VALUES (102, 'SUPER MARIO ODYSSEY', TO_DATE('2017-10-27', 'YYYY-MM-DD'), 2, 20);
INSERT INTO JUEGOS(ID_JUEGO, TITULO, FECHA_LANZAMIENTO, ID_DESARROLLADOR, ID_GENERO)
VALUES (103, 'CALL OF DUTY: MODERN WARFARE III', TO_DATE('2023-11-10', 'YYYY-MM-DD'), 3, 30);
INSERT INTO JUEGOS(ID_JUEGO, TITULO, FECHA_LANZAMIENTO, ID_DESARROLLADOR, ID_GENERO)
VALUES (104, 'DOTA 2', TO_DATE('2013-07-09', 'YYYY-MM-DD'), 4, 40);

INSERT INTO PLATAFORMAS(ID_PLATAFORMA, NOMBRE) VALUES (1, 'PC');
INSERT INTO PLATAFORMAS(ID_PLATAFORMA, NOMBRE) VALUES (2, 'PLAYSTATION');
INSERT INTO PLATAFORMAS(ID_PLATAFORMA, NOMBRE) VALUES (3, 'NINTENDO SWITCH');

INSERT INTO JUEGOS_PLATAFORMA(ID_JUEGO, ID_PLATAFORMA) VALUES (101,1);
INSERT INTO JUEGOS_PLATAFORMA(ID_JUEGO, ID_PLATAFORMA) VALUES (101,3);
INSERT INTO JUEGOS_PLATAFORMA(ID_JUEGO, ID_PLATAFORMA) VALUES (102,3);
INSERT INTO JUEGOS_PLATAFORMA(ID_JUEGO, ID_PLATAFORMA) VALUES (103,1);
INSERT INTO JUEGOS_PLATAFORMA(ID_JUEGO, ID_PLATAFORMA) VALUES (103,2);

CREATE OR REPLACE VIEW V_DETALLE_JUEGOS AS
SELECT
    J.ID_JUEGO,
    J.TITULO,
    G.NOMBRE_GENERO,
    D.NOMBRE_DESARROLLADOR,
    J.FECHA_LANZAMIENTO
FROM JUEGOS J
LEFT JOIN GENEROS G ON J.ID_GENERO = G.ID_GENERO
LEFT JOIN DESARROLLADORES D ON J.ID_DESARROLLADOR = D.ID_DESARROLLADOR
ORDER BY J.ID_JUEGO;

CREATE OR REPLACE PROCEDURE SP_INSERTAR_JUEGO (
    p_id IN NUMBER,
    p_titulo IN VARCHAR2,
    p_fecha IN VARCHAR2,
    p_id_dev IN NUMBER,
    p_id_gen IN NUMBER
) AS
BEGIN
    INSERT INTO JUEGOS (ID_JUEGO, TITULO, FECHA_LANZAMIENTO, ID_DESARROLLADOR, ID_GENERO)
    VALUES (p_id, p_titulo, TO_DATE(p_fecha, 'YYYY-MM-DD'), p_id_dev, p_id_gen);
END;
/

CREATE OR REPLACE PROCEDURE SP_INSERTAR_DESARROLLADOR (
    p_id IN NUMBER,
    p_nombre IN VARCHAR2
) AS
BEGIN
    INSERT INTO DESARROLLADORES (ID_DESARROLLADOR, NOMBRE_DESARROLLADOR)
    VALUES (p_id, p_nombre);
END;
/

CREATE OR REPLACE PROCEDURE SP_INSERTAR_GENERO (
    p_id IN NUMBER,
    p_nombre IN VARCHAR2
) AS
BEGIN
    INSERT INTO GENEROS (ID_GENERO, NOMBRE_GENERO)
    VALUES (p_id, p_nombre);
END;
/

DECLARE
    e_object_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_object_exists, -00955);
BEGIN
    EXECUTE IMMEDIATE 'CREATE TABLE AUDITORIA_JUEGOS (
        ID_AUDITORIA NUMBER PRIMARY KEY,
        MENSAJE VARCHAR2(200),
        FECHA_SUCESO TIMESTAMP
    )';
EXCEPTION
    WHEN e_object_exists THEN NULL;
END;
/

DECLARE
    e_object_exists EXCEPTION;
    PRAGMA EXCEPTION_INIT(e_object_exists, -00955);
BEGIN
    EXECUTE IMMEDIATE 'CREATE SEQUENCE SEQ_AUDITORIA_ID START WITH 1 INCREMENT BY 1';
EXCEPTION
    WHEN e_object_exists THEN NULL;
END;
/

CREATE OR REPLACE TRIGGER TRG_AUDIT_ID_INC
BEFORE INSERT ON AUDITORIA_JUEGOS
FOR EACH ROW
BEGIN
  SELECT SEQ_AUDITORIA_ID.NEXTVAL INTO :new.ID_AUDITORIA FROM dual;
END;
/

CREATE OR REPLACE TRIGGER TRG_AUDIT_INSERT_JUEGO
AFTER INSERT ON JUEGOS
FOR EACH ROW
BEGIN
    INSERT INTO AUDITORIA_JUEGOS (MENSAJE, FECHA_SUCESO)
    VALUES ('Se insert√≥ el juego: ' || :NEW.TITULO, SYSTIMESTAMP);
END;
/

COMMIT;